services:
  # postgres:
  #   image: "postgres:16"
  #   environment:
  #     - "POSTGRES_USER=${SERVICE_USER_POSTGRES}"
  #     - "POSTGRES_PASSWORD=${SERVICE_PASSWORD_POSTGRES}"
  #     - "POSTGRES_DB=${SERVICE_DB_POSTGRES:-usesend}"
  #   healthcheck:
  #     test:
  #       - CMD-SHELL
  #       - "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"
  #     interval: 5s
  #     timeout: 20s
  #     retries: 10
  #   volumes:
  #     - "usesend-postgres-data:/var/lib/postgresql/data"
  smtp-server:
    build:
      context: apps/smtp-server
      dockerfile: Dockerfile
    environment:
      - "SMTP_AUTH_USERNAME:${SMTP_AUTH_USERNAME:?}"
      - "USESEND_BASE_URL:${USESEND_BASE_URL:?}"
      - "USESEND_API_KEY_PATH:${USESEND_API_KEY_PATH:-/data/certs/key.pem}"
      - "USESEND_API_CERT_PATH:${USESEND_API_CERT_PATH:-/data/certs/cert.pem}"
    ports:
      - 25:25
      - 587:587
      - 2587:2587
      - 465:465
      - 2465:2465
    restart: unless-stopped
    volumes:
      - /data/coolify/certs/*.dev.gigantic.engineering:/data/certs:ro
  usesend:
    build:
      context: .
      dockerfile: docker/Dockerfile
    expose:
      - 3000
    labels:
      - "${LABEL_TRAEFIK_SNS_ENTRYPOINTS}"
      - "${LABEL_TRAEFIK_SNS_TLS}"
      - "${LABEL_TRAEFIK_SNS_CERTRESOLVER}"
      - "${LABEL_TRAEFIK_SNS_MIDDLEWARES}"
      - "${LABEL_TRAEFIK_SNS_RULE}"
      - "${LABEL_TRAEFIK_SNS_SERVICE}"
    environment:
      - SERVICE_URL_USESEND_3000
      - "DATABASE_URL=postgresql://${SERVICE_USER_POSTGRES}:${SERVICE_PASSWORD_POSTGRES}@${SERVICE_HOST_POSTGRES}:${SERVICE_PORT_POSTGRES:-5432}/${SERVICE_DB_POSTGRES:-usesend}"
      - "NEXTAUTH_URL=${SERVICE_URL_USESEND}"
      - "NEXTAUTH_SECRET=${SERVICE_BASE64_64_NEXTAUTHSECRET}"
      - "AWS_ACCESS_KEY=${AWS_ACCESS_KEY:?}"
      - "AWS_SECRET_KEY=${AWS_SECRET_KEY:?}"
      - "AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION:?}"
      - "GITHUB_ID=${GITHUB_ID}"
      - "GITHUB_SECRET=${GITHUB_SECRET}"
      - "OAUTH_PROVIDER_ID=${OAUTH_PROVIDER_ID:?}"
      - "OAUTH_PROVIDER_NAME=${OAUTH_PROVIDER_NAME:?}"
      - "OAUTH_PROVIDER_CLIENT_ID=${OAUTH_PROVIDER_CLIENT_ID:?}"
      - "OAUTH_PROVIDER_CLIENT_SECRET=${OAUTH_PROVIDER_CLIENT_SECRET:?}"
      - "OAUTH_PROVIDER_WELL_KNOWN_URL=${OAUTH_PROVIDER_WELL_KNOWN_URL:?}"
      - "REDIS_URL=${REDIS_URL:?}"
      - "NEXT_PUBLIC_IS_CLOUD=${NEXT_PUBLIC_IS_CLOUD:-false}"
      - "API_RATE_LIMIT=${API_RATE_LIMIT:-1}"
      - HOSTNAME=0.0.0.0
    healthcheck:
      test:
        - CMD-SHELL
        - "wget -qO- http://usesend:3000 || exit 1"
      interval: 5s
      retries: 10
      timeout: 2s
